var iSuggester = {

	serverUrl : "/suggester", /* Сервер, возвращающий саггесты */
	sypexKeys : ["ypUOZ", "aHS9V", "hS9MH", "HRbLwB", "9y5AP", "e49h7", "yN9yi", "bXJLc", "hs7XQ", "M13Jh"],
	searchBox : null, /* html объект строки поиска */
	suggestions : null, /* Список саггестов */
	activeSuggestion : null, /* Выбранный саггест */
	activeSearch : null, /* Эта вещь поможет нам абортить лишние запросы к серверу */
	userGeolocationData : null, /* Геолокационные данные пользователя */
	userCity : null, /* Город пользователя */
	addressFields : null, /* Список айдишников полей, в которые нужно разобрать адрес*/
	suggestionsBox : {  /* div для саггестов */
		placeholder : null, /* Главный div */
		hint : null, /* div с хинтом */
		selectable : null /* выбираемые div с саггестами */
	},
	
	init : function(params) { /* Функция инициализирующая саггестор */

		this.searchBox = document.getElementById(params.searchBox); /* Запоминаем строку для ввода адреса */
		this.addressFields = params.addressFields; /* Запоминаем id филдов для разобранного адреса */

		if (this.searchBox == null || this.searchBox == undefined) { /* Проверяем, что у нас правильно инициализировано поле поиска */
			return false;
		}

		this.buildSuggestionsPlaceholder();
		// this.getUserCityByIP(); /* получаем город пользователя по IP адресу */
		// this.getUserGeolocationData(); /* получаем геолокацию пользователя */
	},
	
	getUserGeolocationData : function() { /* Функция получения геопозиции пользователя */
		if (navigator.geolocation) { /* Проверяем, умеет ли браузер получать геопозицию. Не умеет IE 8 и ниже. */
			window.navigator.geolocation.getCurrentPosition(this.setUserGeolocationData, this.handleErrorOfGettingUserGeolocationData);
		} else { /* Не умеет получать геопозицию :( */
			console.log("Браузер не поддерживает передачу геопозиции :(");
		}
	},
	
	setUserGeolocationData : function(position) { /* Функция сохранения геопозиции пользователя */
		var coordinates = position.coords;
		var userGeolocationData = {};
		userGeolocationData.latitude = coordinates.latitude; /* Широта */
		userGeolocationData.longitude = coordinates.longitude; /* Долгота */
		userGeolocationData.accuracy = coordinates.accuracy; /* Точность */
		iSuggester.userGeolocationData = userGeolocationData;
		iSuggester.getSuggestions("/getAddress?point=" + userGeolocationData.longitude + "," + userGeolocationData.latitude + "&radius=" + userGeolocationData.accuracy);
	},
	
	handleErrorOfGettingUserGeolocationData : function(error) {	/* Функция обработки ошибок получения геопозиции пользователя */
		switch(error.code) {
			case error.PERMISSION_DENIED:
				console.log("Вы отклонили запрос геолокации :(");
				break;
			case error.POSITION_UNAVAILABLE:
				console.log("Информация о положении недоступна :(");
				break;
			case error.TIMEOUT:
				console.log("Время получения геопозиции истекло :(");
				break;
			case error.UNKNOWN_ERROR:
				console.log("При получении геолокации произошла неизвестная ошибка :(");
				break;
		}
	},
	
	getUserCityByIP : function() { /* Функция получения города пользователя по его IP адресу */
		this.sendAjax("http://api.sypexgeo.net/ypUOZ/json", this.setUserCity); /* TODO Решить откуда берем город */
	},

	setUserCity : function(ipData) { /* Функция сохранения города пользователя (полученного по IP) */
		iSuggester.userCity = ipData.city.name_ru;
	},
	
	buildSuggestionsPlaceholder : function() { /* Создаем плейсхолдер для саггестов */

	},
	
	stylingSuggestionsPlaceholder : function() { /* Добавляем стили плейсхолдеру для саггестов */

	},

	getSuggestions : function(query) { /* Получаем саггесты */
		this.sendAjax(this.serverUrl + query, this.setSuggestions);
	},

	setSuggestions : function(suggestions) { /* Сохраняем саггесты */
		iSuggester.suggestions = suggestions;
	},
	
	renderSuggestions : function() { /* Отрисовываем саггесты */

	},
	
	stylingSuggestions : function() { /* Добавляем стили для саггестов */

	},
	
	addHintSuggest : function() { /* Добавляет саггест-хинт ("Выберите вариант или продолжите ввод") */

	},

	createDiv : function(attributes) { /* Функция для создания div'a */
		return "div";
	},
	
	setActiveSuggest : function() { /* Функция, срабатывающая при выборе саггеста */
		
	},
	
	handleClickOnSearchBox : function() { /* Функция, срабатывающая при клике мышью в строку поиска */
		
	},
	
	handleKeyPress : function() { /* Обрабатываем нажания кнопок, когда строка поиска в фокусе */
		/*
			1. 38 Клацаем стреку "Вверх" : this.handleUpArrowKeyPress();
			2. 40 Клацаем стреку "Вниз" : this.handleDownArrowKeyPress();
			3. 13 Клацаем кнопку "Enter" : this.handleEnterKeyPress();
			4. Вводим буквы/цифры/backspace/delete : this.handleAddressTyping();
			5. tab, caps lock, shift, ctrl, alt, arrow <- и ->, home, end, pageDown, pageUp, f1-f12, esc
				9, 20, 16, 17, 18, 37, 39, 36, 35, 34, 33, 27, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123
		*/
	},
	
	handleUpArrowKeyPress: function() { /* Обрабатываем нажания стрелки "Вверх" */
		
	},
	
	handleDownArrowKeyPress: function() { /* Обрабатываем нажания стрелки "Вниз" */
		
	},
	
	handleEnterKeyPress: function() { /* Обрабатываем нажания кнопки "Enter" */
		
	},
	
	handleAddressTyping : function() { /* Обрабатываем ввод адреса */
		
	},
	
	injectAddress : function() { /* Разбираем адрес по кусочкам */
		
	},

	sendAjax : function(url, callBack) { /* Асинхронный xhr запрос */
		var ajax = new XMLHttpRequest();
		ajax.open("GET", url);
		ajax.send();

		ajax.onload = function() {
			var response = ajax.responseText;

			if (typeof(response) == "string") { /* Проверяем контент-тайп ответа */
				response = JSON.parse(response);
			}

			if (callBack != null && callBack != undefined) {
				callBack(response); /* Обрабатываем ответ */
			}
		}
	}
}