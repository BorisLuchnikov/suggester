var iSuggester={serverUrl:"/suggester",searchBox:null,suggestions:[],activeSuggestion:null,activeSearch:null,userGeolocationData:null,userCity:null,addressFields:null,suggestionsBox:{placeholder:null,hint:null,selectable:null},init:function(e){return this.searchBox=document.getElementById(e.searchBox),this.addressFields=e.addressFields,null==this.searchBox||void 0==this.searchBox?!1:(this.buildSuggestionsPlaceholder(),this.getUserCityByIP(),this.getUserGeolocationData(),this.searchBox.onclick=function(e){iSuggester.handleClickOnSearchBox(e)},this.searchBox.onkeyup=function(e){iSuggester.handleKeyPress(e)},void(window.onclick=function(){iSuggester.hideSuggestionsPlaceholder()}))},getUserGeolocationData:function(){navigator.geolocation?window.navigator.geolocation.getCurrentPosition(this.setUserGeolocationData):console.log("Браузер не поддерживает передачу геопозиции :(")},setUserGeolocationData:function(e){var t=e.coords,s={};s.latitude=t.latitude,s.longitude=t.longitude,s.accuracy=t.accuracy>250?250:t.accuracy,iSuggester.userGeolocationData=s,iSuggester.getSuggestions("/getAddress?point="+s.longitude+","+s.latitude+"&radius="+s.accuracy)},getUserCityByIP:function(){this.sendAjax("http://api.sypexgeo.net/ypUOZ/json",this.setUserCity)},setUserCity:function(e){iSuggester.userCity=e.city.name_ru},buildSuggestionsPlaceholder:function(){var e={id:"placeholder"+(new Date).getTime(),style:"width: "+this.searchBox.offsetWidth+"px; font-size: 14px; font-family: Arial; position: absolute; display: none; z-index: 999;"},t={id:"hint"+(new Date).getTime(),style:"background-color: #FAFAFA; color: #808080; padding: 5px 25px; font-size: 12px;"},s={id:"selectable"+(new Date).getTime()},i=this.createDiv(e),n=this.createDiv(t),o=this.createDiv(s);i.appendChild(n),i.appendChild(o),this.searchBox.parentNode.insertBefore(i,this.searchBox.nextSibling),this.suggestionsBox.placeholder=i,this.suggestionsBox.hint=n,this.suggestionsBox.selectable=o},stylingSuggestionsPlaceholder:function(){var e=this.searchBox.getBoundingClientRect(),t=this.suggestionsBox.placeholder.style;t.left=e.left+"px",t.top=e.top+this.searchBox.offsetHeight+window.pageYOffset+7+"px",t.display=""},stylingActiveSuggestion:function(){this.activeSuggestion.style.backgroundColor="#EDEDED"},hideSuggestionsPlaceholder:function(){this.suggestionsBox.placeholder.style.display="none"},getSuggestions:function(e){this.sendAjax(this.serverUrl+e,this.setSuggestions)},setSuggestions:function(e){iSuggester.suggestions=e,iSuggester.renderSuggestions()},renderSuggestions:function(){var e=iSuggester.suggestionsBox.selectable;e.innerHTML="",this.suggestions.forEach(function(t){var s={id:t.id,style:"background-color: #FAFAFA; cursor: pointer; padding: 10px;"},i=iSuggester.createDiv(s);i.innerHTML=(t.city?t.city+", ":"")+(t.address_name?t.address_name+(t.address_name==t.name?"":" ("+t.name+")"):t.name),i.onmouseover=function(){i.style.backgroundColor="#EDEDED"},i.onmouseout=function(){i.style.backgroundColor="#FAFAFA"},i.onclick=function(){iSuggester.setActiveSuggestion(i,!0)},e.appendChild(i)}),this.addHintSuggest()},addHintSuggest:function(){var e=this.suggestionsBox.hint,t=this.searchBox.value,s=this.suggestions.length>0?!0:!1;t||s?!t&&s?e.innerHTML="Выберите вариант или введите адрес в свободной форме":t&&!s?e.innerHTML="Продолжите ввод":e.innerHTML="Выберите вариант или продолжите ввод":e.innerHTML="Введите адрес в свободной форме"},createDiv:function(e){var t=document.createElement("div");for(attribute in e)t.setAttribute(attribute,e[attribute]);return t},setActiveSuggestion:function(e,t){e||(e=this.activeSuggestion),this.searchBox.value=e.textContent+" ",this.searchBox.focus(),t&&this.addressFields&&this.sendAjax(this.serverUrl+"/getAddressById?id="+e.id,this.injectAddress)},handleClickOnSearchBox:function(e){e.stopPropagation(),this.searchBox.value||(this.searchBox.value=this.userCity+", "),this.addHintSuggest(),this.stylingSuggestionsPlaceholder()},handleKeyPress:function(e){e=e||window.event;var t=e.keyCode,s=[9,20,16,17,18,37,39,36,35,34,33,27];return-1!=s.indexOf(t)?!1:void(38==t?this.handleUpArrowKeyPress():40==t?this.handleDownArrowKeyPress():13==t?this.handleEnterKeyPress():this.handleAddressTyping())},handleUpArrowKeyPress:function(){this.activeSuggestion?(this.activeSuggestion.style.backgroundColor="#FAFAFA",this.activeSuggestion=this.activeSuggestion.previousSibling):this.activeSuggestion=this.suggestionsBox.selectable.lastChild,this.activeSuggestion||(this.activeSuggestion=this.suggestionsBox.selectable.lastChild),this.stylingActiveSuggestion(),this.setActiveSuggestion()},handleDownArrowKeyPress:function(){this.activeSuggestion?(this.activeSuggestion.style.backgroundColor="#FAFAFA",this.activeSuggestion=this.activeSuggestion.nextSibling):this.activeSuggestion=this.suggestionsBox.selectable.firstChild,this.activeSuggestion||(this.activeSuggestion=this.suggestionsBox.selectable.firstChild),this.stylingActiveSuggestion(),this.setActiveSuggestion()},handleEnterKeyPress:function(){this.hideSuggestionsPlaceholder(),this.setActiveSuggestion(null,!0)},handleAddressTyping:function(){"none"==this.suggestionsBox.placeholder.style.display&&this.stylingSuggestionsPlaceholder();var e=this.searchBox.value;e.length>=2&&(null!=this.activeSearch&&clearTimeout(this.activeSearch),this.activeSearch=setTimeout(function(){iSuggester.getSuggestions("/getAddressByQuery?q="+encodeURI(e))},200))},injectAddress:function(e){var t,s,i,n,o,a,r,g,u,l=e.result.items[0],c=iSuggester.addressFields,d=function(e){return document.getElementById(e)};for(key in c){var h=d(c[key]);h&&(h.value="")}var v=l.adm_div,S=l.address,y=l.floors;t=l.name,v&&v.forEach(function(e){"city"==e.type?n=e.name:"district"==e.type&&(o=e.name)}),S&&(u=S.components,i=S.postcode),u&&u.forEach(function(e){"street_number"==e.type&&(a=e.street,r=e.number,s=(n?n:"")+(a?", "+a:"")+(r?", "+r:""))}),y&&(g=y.ground_count);var f=d(c.name),p=d(c.address),x=d(c.postcode),B=d(c.city),A=d(c.district),m=d(c.street),b=d(c.number),C=d(c.floors);t&&f&&(f.value=t),s&&p&&(p.value=s),i&&x&&(x.value=i),n&&B&&(B.value=n),o&&A&&(A.value=o),a&&m&&(m.value=a),r&&b&&(b.value=r),g&&C&&(C.value=g)},sendAjax:function(e,t){var s=new XMLHttpRequest;s.open("GET",e),s.send(),s.onload=function(){var e=s.responseText;0==e.length&&(e=[]),"string"==typeof e&&(e=JSON.parse(e)),null!=t&&void 0!=t&&t(e)}}};